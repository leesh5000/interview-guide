generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions InterviewQuestion[]
}

model TargetRole {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InterviewQuestion {
  id             String   @id @default(uuid())
  categoryId     String
  category       Category @relation(fields: [categoryId], references: [id])

  // 질문 정보
  questionTitle     String              // 질문 제목
  questionBody      String   @db.Text   // 질문 본문 (의도, 평가포인트 등 - 마크다운)
  answerContent     String   @db.Text   // 답변 내용 (마크다운)
  followUpQuestions String   @db.Text @default("")  // 꼬리 질문 (마크다운)

  // 메타 정보
  targetRoles    String[]            // 대상: ["공통", "백엔드 개발자", "DB 엔지니어"]
  tags           String[]            // 태그: ["인덱스", "쿼리최적화", "Explain"]

  // AI 및 강의
  aiSummary      String?             // AI 생성 요약
  relatedCourses Json     @default("[]") // [{title: string, affiliateUrl: string}]

  // 상태
  viewCount      Int      @default(0)
  isPublished    Boolean  @default(false)
  reviewCount    Int      @default(0)  // 커뮤니티 검수 횟수
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 관계
  suggestions    SuggestionRequest[]

  @@index([categoryId])
  @@index([isPublished])
}

// 수정 제안 상태
enum SuggestionStatus {
  PENDING   // 대기 중
  APPROVED  // 승인됨
  REJECTED  // 반려됨
}

// 수정 제안 모델
model SuggestionRequest {
  id            String   @id @default(uuid())
  questionId    String
  question      InterviewQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // 수정 내용 (본문, 답변만)
  questionBody  String   @db.Text
  answerContent String   @db.Text

  // 수정 사유 (필수)
  reason        String   @db.Text

  // 요청자 정보
  requesterIp   String

  // 상태 관리
  status        SuggestionStatus @default(PENDING)
  adminComment  String?  @db.Text  // 반려 사유 (선택)

  createdAt     DateTime @default(now())
  reviewedAt    DateTime?

  @@index([questionId])
  @@index([status])
  @@index([requesterIp, createdAt])
}

// 강의 링크 클릭 추적
model CourseClick {
  id           String   @id @default(uuid())
  questionId   String
  affiliateUrl String
  clickCount   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([questionId, affiliateUrl])
  @@index([questionId])
}

// 강의 관리
model Course {
  id           String   @id @default(uuid())
  title        String
  affiliateUrl String   @unique  // 제휴 링크 (고유)
  thumbnailUrl String?            // 썸네일 이미지 URL
  description  String?            // 강의 설명 (선택)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([title])
}

// 일별 강의 클릭 로그 (오늘의 인기 강의용)
model DailyClickLog {
  id           String   @id @default(uuid())
  affiliateUrl String
  date         DateTime @db.Date  // 날짜만 저장 (시간 제외)
  clickCount   Int      @default(0)
  createdAt    DateTime @default(now())

  @@unique([affiliateUrl, date])
  @@index([date])
}

// 오늘의 개발 소식
model DailyNews {
  id             String   @id @default(uuid())
  title          String                    // 기사 제목
  originalUrl    String   @unique          // 원본 기사 URL (중복 방지)
  sourceUrl      String                    // 뉴스 소스 URL (GeekNews 등)
  description    String?  @db.Text         // 원본 설명
  aiSummary      String   @db.Text         // AI 요약
  relatedCourses Json     @default("[]")   // 관련 강의 [{courseId, title, affiliateUrl, matchScore}]
  publishedAt    DateTime                  // 원본 기사 발행일
  fetchedAt      DateTime @default(now())  // 수집 시간
  displayDate    DateTime @db.Date         // 표시 날짜 (KST 기준)

  @@index([displayDate])
  @@index([publishedAt])
}

// Cron 작업 실행 로그
model CronLog {
  id           String   @id @default(uuid())
  jobName      String                    // 작업 이름 (daily-news 등)
  status       String                    // 상태 (success, error)
  message      String?  @db.Text         // 결과 메시지
  processedCount Int    @default(0)      // 처리된 항목 수
  errorDetail  String?  @db.Text         // 에러 상세 (실패 시)
  duration     Int?                      // 실행 시간 (ms)
  executedAt   DateTime @default(now())  // 실행 시간

  @@index([jobName])
  @@index([executedAt])
}
